---
Publish: CVPR2023
Url: https://openaccess.thecvf.com/content/CVPR2023/papers/Xiang_SQUID_Deep_Feature_In-Painting_for_Unsupervised_Anomaly_Detection_CVPR_2023_paper.pdf
Year: "2023"
Month: "00"
代码: https://github.com/tiangexiang/SQUID
Stars: "81"
Title: "SQUID: Deep Feature In-Painting for Unsupervised Anomaly Detection"
---
## 摘要

摄影成像协议侧重于特定的身体区域，因此产生的图像非常相似，并在不同患者之间产生反复出现的解剖结构。为了利用这种结构化信息，我们提出了使用空间感知内存队列进行辐射成像图像修复和异常检测（简称为SQUID）。我们展示了SQUID能够将内在的解剖结构分类为反复出现的模式；在推断中，它可以识别图像中的异常（未见/修改的模式）。SQUID在无监督异常检测方面超过了13种最先进方法，至少在两个胸部X射线基准数据集上以曲线下面积（AUC）衡量超过5点。此外，我们创建了一个新数据集（DigitAnatomy），它综合了胸部解剖学的空间相关性和一致形状。我们希望DigitAnatomy能促进异常检测方法的开发、评估和可解释性。

## 1. 引言 

照片成像和放射成像中的视觉任务是不同的。例如，在照片图像中识别对象时，我们假设平移不变性——一只猫不管出现在图像的左边还是右边都是一只猫。而在放射成像中，结构的相对位置和方向是重要的特征，可以用于识别正常解剖和病理情况。由于放射成像协议在相当一致的方向上评估患者，生成的图像在不同患者、设备制造商和设施位置之间具有很大的相似性。一致和反复出现的解剖学有助于分析许多关键问题，并应被视为放射成像的重要优势。几项研究已经证明了这种先验知识在通过添加位置特征、修改目标函数和约束图像中的地标相对坐标来增强深度网络性能方面的价值。我们的工作试图回答这个关键问题：我们是否可以利用一致的解剖模式及其空间信息来加强深度网络对放射成像图像中异常的检测，而无需手动注释？

无监督异常检测仅使用健康图像进行模型训练，并且不需要其他注释，如疾病诊断或定位。多达80%的临床错误发生在放射科医生最初错过异常的情况下。异常检测的影响在于通过明确指出存在可疑病变，然后让医生深入观察扫描图像来减少那80%。与以前的异常检测方法不同，我们将任务构建为一个修复任务，以利用解剖学上的外观、位置和布局在放射成像图像中的一致性。具体来说，我们提出了用于放射成像图像的空间感知内存队列进行修复和检测异常（简称为SQUID）。在训练过程中，我们的模型可以通过基于它们的空间位置对反复出现的解剖模式进行分类，从而动态地维护一个视觉模式词典。由于解剖学的一致性，预期健康图像中的相同身体区域将表现出相似的视觉模式，这使得唯一模式的总数可以管理。在推断过程中，由于异常模式不存在于词典中，如果存在异常，生成的放射成像图像预期将是不现实的。因此，模型可以通过区分修复任务的质量来识别异常。异常检测的成功有两个基本假设：首先，异常只在数据中偶尔发生；其次，异常与正常模式有显著差异。

我们在两个大规模公开可用的放射成像数据集上进行了实验。我们的SQUID在无监督异常检测方面明显优于主流方法，超过了张力实验室数据集上的5点；值得注意的是，我们在斯坦福CheXpert数据集上的13种最近的无监督异常检测方法中取得了10点的改进。此外，我们创建了一个新数据集（DigitAnatomy），以阐明放射成像中胸部解剖的空间相关性和一致形状。DigitAnatomy致力于简化异常检测方法的开发、评估和可解释性。定性可视化清楚地显示了我们的SQUID相对于当前最先进方法的优越性。总之，我们的贡献包括：（I）用于胸部放射成像的最佳性能无监督异常检测方法；（II）一个促进异常检测研究的合成数据集；（III）通过发明空间感知内存队列和特征级修复来克服主导的无监督异常检测方法的局限性。

## 2. 相关工作 

自然成像中的异常检测。异常检测是识别与正常数据分布偏离的罕见事件的任务。早期尝试包括单类支持向量机、字典学习和稀疏编码。由于异常样本数量不足，后续的工作通常将异常检测形式化为无监督学习问题。这些方法大致可分为基于重构和基于密度的方法。

基于重构的方法训练模型（如自动编码器）以恢复原始输入，并通过分析重构误差来识别异常。

基于密度的方法通过估计正常数据分布（例如通过变分自编码器或生成对抗网络）来预测异常。然而，这些方法对正常图像学习的分布无法解释可能的异常。本文通过从同质医学图像中维护视觉模式内存来解决这些限制。一些先前的工作研究了使用图像修复进行异常检测的方法，即对输入图像的部分进行遮挡，然后训练模型以自我监督方式恢复缺失部分。还有许多关于在视频序列中检测异常的工作。Bergmann等人和Salehi等人提出了类似的师生网络，而我们的方法利用这样的结构只提取输入感知特征，推断期间完全禁用师网络。

医学成像中的异常检测。医学领域的异常检测通常是基于病理学的。采用监督学习的方法通常用于检测特定类型的异常，如病变、病理、肿瘤和结节。最近提出了一些无监督方法以检测一般异常，利用生成对抗网络可以在弱标注的情况下实现异常检测。在AnoGAN中，判别器被严重过度拟合到正常图像分布以检测异常。随后，提出了f-AnoGAN来提高计算效率。Marimont等人设计了一个自动解码器网络来拟合正常图像的分布。空间坐标和异常概率被映射到不同组织类型的代理上。Han等人提出了一种两步GAN-based框架来检测MRI切片中的异常。然而，他们的方法依赖于三维MRI序列的体素表示，这在我们的任务中是不可能的。最近，提出了一个混合框架SALAD，它将GAN与自监督技术结合起来。首先对正常图像进行增强，通过像素破坏和像素重排携带伪造的异常。然后，将伪造的异常图像与原始正常图像一起输入GAN，以学习更稳健的特征表示。然而，这些方法需要关于异常类型的强先验知识和假设才能使增强有效。与照片图像不同，放射成像协议产生具有一致解剖模式的图像，由于成像线索微妙且解剖结构重叠，这更具挑战性。与大多数现有工作不同，我们提出了一种新颖的方法，明确利用了放射成像图像的特性，显著提高了从放射成像图像中检测异常的性能。

记忆网络。将记忆模块纳入神经网络已被证明对许多任务是有效的。MemAE首次提出将记忆矩阵用于无监督异常检测。除了自动编码外，还在编码器和解码器之间引入了额外的记忆矩阵，以在训练过程中捕获正常特征模式。基于这一范式，Park等人引入了一个非可学习的记忆模块，可以随着输入的更新而更新。尽管我们提出的Memory Queue也不需要任何梯度，但我们的方法在使用目的和更新规则上有很大不同。考虑到现有方法中额外的内存使用，Lv等人提出了一个动态原型单元，可以实时编码正常动态，同时消耗很少的额外内存。在本文中，我们克服了Memory Matrix的局限性，并提出了一种有效而高效的Memory Queue，用于放射成像图像的无监督异常检测。

  
## SQUID 

### 3.1. 概述（见图2） 

（1）特征提取。我们将输入图像分成N × N个不重叠的块，并将它们送入编码器进行特征提取。提取的特征将用于图像重构。实际上，编码器可以是任何骨干架构；在这项工作中，为了简单起见，我们采用基本的卷积和池化层。 

（2）图像重构。我们引入了教师生成器和学生生成器来重构原始图像。随着重构，将创建一个解剖模式的词典，并动态更新为一个内存队列。具体来说，教师生成器直接使用编码器提取的特征重构图像（本质上是一个自编码器）。另一方面，学生生成器使用我们的修复模块增强的特征。在所有上采样级别上，教师生成器和学生生成器通过知识蒸馏范式相互耦合。学生生成器的目标是从增强的特征中重构出一个正常图像，然后用于异常判别；而教师生成器作为一个正则化项，防止学生不断生成相同的正常图像。 

（3）异常判别。遵循对抗学习的原则，我们使用一个鉴别器来评估生成的图像是真实还是伪造的。只有学生生成器会接收来自鉴别器的梯度。两个生成器和鉴别器相互竞争，直到它们达到平衡。一旦训练完成，鉴别器就可以用于检测测试图像中的异常。