---
Title: "Target before Shooting: Accurate Anomaly Detection and Localization under One Millisecond via Cascade Patch Retrieval"
Publish: arXiv2023
Url: https://arxiv.org/pdf/2308.06748.pdf
Year: "2023"
Month: "08"
---
## 摘要

在这项工作中，通过重新审视异常检测（AD）的“匹配”性质，我们提出了一个新的AD框架，它同时具有新的AD准确性记录和极高的运行速度。在这个框架中，异常检测问题通过级联补丁检索过程解决，该过程以粗到细的方式检索每个测试图像补丁的最近邻。**给定一个测试样本**，首先基于鲁棒的直方图匹配过程**选择了前K个最相似的训练图像**。其次，通过使用经过精心训练的**局部度量**在这些“全局最近邻”上的相似几何位置检索每个**测试补丁**的最近邻。最后，基于到其“局部最近邻”和“非背景”概率的距离计算了每个**测试图像补丁**的异常分数。在本文中，所提出的方法被称为“级联补丁检索”（CPR）。与传统的**基于补丁匹配的AD算法**不同，CPR在“射击”（补丁匹配）之前选择适当的“目标”（参考图像和位置）。在公认的MVTec AD、BTAD和MVTec-3D AD数据集上，所提出的算法通过各种AD指标与所有比较的SOTA方法相比一直表现出色。此外，CPR非常高效。在标准设置下，它以113 FPS的速度运行，而其简化版本只需不到1毫秒即可处理一张图像，成本是微小的准确性下降。CPR的代码可在[https://github.com/flyinghu123/CPR](https://github.com/flyinghu123/CPR) 上找到。

关键词—异常检测，图像补丁检索，度量学习。

## I. 引言 

实现工业级别的异常检测（AD）具有挑战性，因为要求的准确性很高，以确保缺陷检查的可靠性，同时时间预算在运行的装配线上是有限的。最近提出的大多数AD方法都集中在增加识别准确性上，因为在标准设置下，只有正常样本可用于训练，这已经很困难了。

实现“无监督”AD最直接的方法是“单类别”分类策略：将正常图像或补丁视为单一类别，然后可以将异常图像检测为异常值。类似地，基于标准化流的方法继承了单一类别的假设，但另外对类别施加了高斯分布以获得更好的性能。

与单一类别设置相反，一些有区别的异常检测器通过使用真实正常样本和合成异常样本学习像素级二元分类器，通常可以在一定程度上提高AD准确性。另一方面，基于蒸馏的AD方法从“教师”网络中提取“知识”，该网络在与AD无关的数据集上进行了预训练，然后将每个图像区域的异常分数基于两个网络之间的响应差异计算。

通过将异常区域视为“遮挡”或“噪声”，一些研究人员提出通过图像重建来检测异常，而异常分数与重建残差正相关。与其他异常检测器的复杂框架相比，[[PatchCore]]通过简单的**补丁匹配**/检索过程可以实现最先进的AD准确性。PatchCore的成功启发了一些其变体，它们试图基于更多信息的补丁特征来提高AD性能。最近一些AD方法提出在检测异常之前明确或隐含地进行图像对齐。通过这种方式，图像补丁只能与类似几何位置的（原始或重建的）正常补丁进行比较。在这项工作中，通过研究AD的固有“匹配”特性，我们提出了一个更加优雅的框架来解决AD问题。我们发现，适当选择的参考集可以在匹配过程中显着受益，无论是在效率上还是准确性上。所提出的框架的主要方案如图1所示。正如图中左侧部分所示，传统的最近邻搜索方法通过在整个参考“库”上以蛮力方式搜索测试补丁的最近原型。通过这种方式，一个异常补丁可能与一个正常补丁“完美”匹配，这与查询样本完全几何无关。因此，这种不令人信服的补丁匹配/检索通常意味着对应本地区域的AD失败。采用“对齐和匹配”策略似乎是更好的选择，因为图像首先被对齐以生成具有几何意义的匹配对。然而，当对测试图像的对齐失败时，几何约束可能导致更糟糕的AD结果。相反，我们以“目标和射击”的方式进行检索。正如图1右侧所示，与其对齐测试图像，我们为每个测试补丁选择适当的参考“目标”。具体而言，合格的目标样本应位于与测试补丁相似的图像坐标处，并且只能从全局检索阶段获取的参考图像中提取。本地检索是在使用经过精心定制的对比损失学习的特征空间中进行的，并且具有高准确性。与“对齐和匹配”策略不同，级联方案自然对全局检索错误具有鲁棒性，因此保证了检索的高召回率。我们将所提出的方法称为“级联补丁检索”（CPR），因为检索是通过两阶段级联过程实现的。对于每个测试补丁，我们的CPR模型首先在Oracle中选择合格的参考样本，然后将查询补丁与所选参考进行匹配。用比喻的话说，CPR在“射击”之前“瞄准”了适当的参考。在本文的广泛实验中，所提出的“目标和射击”方法展示了非常高的AD准确性以及时间效率。总之，本文的贡献如下所述。 • 首先，我们将AD任务作为级联检索问题。与在补丁库上进行蛮力搜索或将测试图像对齐到“标准”姿势相反，级联检索策略自然具有较高的检索召回率，并提供了学习更好的检索度量的充足空间。 • 其次，为了解决大多数AD数据集下少样本条件下的过拟合问题，我们提出了一个新颖的度量学习框架，其中包括定制对比损失和更保守的学习策略。得到的CPR模型在三个公认的AD数据集，即MVTec AD、MVTec-3D AD和BTAD上，通过大幅度优于现有的SOTA算法。 • 最后，在这项工作中，原始的CPR算法被巧妙简化以提高效率。CPR的最快版本，即CPR-Faster，以1000 FPS以上的速度运行，同时仍保持着对大多数当前SOTA方法的准确性优势。

本文的其余部分组织如下：在第II节中，介绍了所提算法的相关工作；在第III节中描述了CPR算法的细节；我们在第IV节报告了所有的实验结果；第V节总结了本文并讨论了CPR的未来工作。