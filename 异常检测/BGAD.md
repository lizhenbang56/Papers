---
创新点: 使用真正的异常图像和合成的异常图像进行监督
Publish: CVPR2023
文档链接: "[[2207.01463 BGAD.pdf]]"
代码: github.com/xcyao00/BGAD
监督方式: 有监督
Year: "2023"
标题: Explicit boundary guided semi-push-pull contrastive learning for supervised anomaly detection
合成异常的方式: 基于RPAG策略在图像上添加噪声
Month: "07"
方法类别: 基于异常图像显式监督
I-AUROC-MVTecAD单类半监督: "99.3"
P-AUROC-MVTecAD单类半监督: "99.2"
类别数: 单类
---
# 摘要

大多数异常检测（AD）模型是以无监督的方式仅使用正常样本进行学习的，这可能导致决策边界不明确且可区分性不足。实际上，在现实世界的应用中通常会有一些异常样本可用，已知异常的宝贵知识也应该被有效利用。然而，在训练过程中利用少量已知异常可能会引起另一个问题，即模型可能会被这些已知异常所偏倚，并且无法泛化到未见的异常。在本文中，我们解决了监督异常检测，即**利用少量可用异常样本**学习AD模型，目的是检测已知和未知的异常。我们提出了一种新颖的显式边界引导的半推-半拉**对比学习**机制，它可以增强模型的可区分性，同时减轻偏倚问题。我们的方法基于两个核心设计：
- 首先，我们找到一个显式而紧凑的分隔边界作为进一步特征学习的指导。由于边界仅依赖于正常特征分布，因此可以缓解由少量已知异常引起的偏倚问题。
- 其次，我们开发了一个边界引导的半推-半拉损失，只将正常特征拉在一起，同时将异常特征推离分隔边界超出一定的间隔区域。

通过这种方式，我们的模型可以形成一个更显式和具有区分性的决策边界，更有效地区分已知和未知异常与正常样本。代码将在[https://github.com/xcyao00/BGAD上提供。](https://github.com/xcyao00/BGAD%E4%B8%8A%E6%8F%90%E4%BE%9B%E3%80%82)

# 引言

异常检测（AD）在各个领域都受到了广泛关注，例如工业缺陷检测[4,8,10,50]和医学病变检测[12,38]。大多数先前的异常检测方法[1, 3, 5, 6, 8, 10, 15, 30, 33, 47, 50–52]都是无监督的，并且非常关注正常样本，而无意中忽略了异常，因为收集足够多种类的异常是困难的。然而，仅从正常样本学习可能会限制AD模型的区分性[12,24]。如图1(a)所示，在没有异常的情况下，决策边界通常是隐式的且不够具有区分性。由于缺乏有关异常的知识，不足的区分性是无监督异常检测中的常见问题。实际上，**在现实世界的应用中通常会有一些异常可用**，可以有效地利用它们来解决或减轻这个问题。最近，可以称为半监督AD [27,34,36]或带有异常暴露的AD [16,17]的方法开始专注于这些可用的异常。这些方法尝试通过单类分类将异常视为负样本[34,36]或通过监督二元分类[16,17]或利用偏差损失优化一个异常评分网络[27]来从异常中学习知识。它们表明即使有一些异常，检测性能也可以显著提高。然而，已知的异常无法代表所有类型的异常。这些方法可能会被已知的异常所偏倚，并且无法泛化到未知的异常（见图5）。

【提出本文解决方案】因此，为了解决上述两个问题，我们解决了监督异常检测[12]，其中可以有效地利用少量已知异常来训练具有区分性的AD模型，以提高对已知异常的检测性能并良好地泛化到未知异常。与无监督AD相比，监督AD对于现实世界的AD应用更有意义，因为检测到的异常可以用于进一步提高模型的区分性和泛化性。为此，我们提出了一种新颖的边界引导异常检测（BGAD）模型，其具有如图1所示的两个核心设计：显式边界生成和边界引导优化。 
- 显式边界生成。我们首先使用正则化流[14]学习正常特征分布的归一化，并获得一个显式的分隔边界，它靠近正常特征分布的边缘，并由一个超参数β（即图1(b)中的正常边界）控制。获得的显式分隔边界仅依赖于正常分布，与异常样本无关，因此可以缓解由于已知异常不足引起的偏倚问题。
- 边界引导优化。在获得显式分隔边界之后，我们提出了一个边界引导半推-半拉（BG-SPP）损失，以利用异常学习更具区分性的特征。通过BG-SPP损失，只有其对数似然小于边界的正常特征被拉在一起形成更紧凑的正常特征分布（半拉）；而其对数似然大于边界的异常特征则被推离边界超出一定的间隔区域（半推）。

通过这种方式，我们的模型可以形成更显式和具有区分性的分隔边界，以及用于更有效地区分异常的可靠间隔区域（见图1(c)，6）。此外，**异常的稀有性**是一个关键问题，可能导致特征学习效率低下。因此，我们提出了基于RandAugment的伪异常生成，可以通过在正常样本中创建局部不规则性来模拟异常，以解决稀有性挑战。 总之，我们的主要贡献如下：

1. 我们提出了一种新颖的显式边界引导的监督AD建模方法，通过设计良好的显式边界生成和边界引导优化，有效利用正常和异常样本。通过所提出的AD方法，可以同时实现更高的区分性和较低的偏倚风险。
2. 为了有效利用少量已知异常，我们提出了一个BG-SPP损失，将正常特征拉在一起，同时将异常特征推离分隔边界，从而可以学习更具区分性的特征。
3. 我们在广泛使用的MVTecAD基准测试上取得了SOTA结果，图像级AUROC为99.3%，像素级AUROC为99.2%。

#### 相关工作
##### Supervised Approaches
[[DeepSAD]]
[[DeepSVDD]]
[[FCDD]]
[[DRA]]
# Our Proposed Approach
## Problem Statement

训练集包括大量正常图像和少量异常图像：$\mathcal{I}_{train} = \mathcal{I}^{n} \cup \mathcal{I}^a$，是一个集合。
任务是学习一个模型 $m : \mathcal{I} \to \mathbb{R}$，输入是一幅图像，输出是一个标量。

## Learning More Discriminative Features by Boundary Guided Semi-Push-Pull

通过显式的正常和异常边界，我们提出了一种边界引导的半推-半拉（BG-SPP）损失，用于更具区分性的特征学习。BG-SPP损失的公式定义如下：$\mathcal {L}_{bg-spp} = \sum _{i=1}^{N}|\text{min}((\rm{log}p_i-b_n),0)|+ \sum _{j=1}^{M}|{\rm max}(({\rm log}p_j - b_n + \tau ),0)|$

在第二阶段的训练中，目标函数如下：$\mathcal {L} = \mathcal {L}_{ml} + \lambda \mathcal {L}_{bg-spp}$
## RandAugment-based Pseudo Anomaly Generation
  
异常通常比正常样本少得多，这可能导致特征学习效率低下。因此，我们提出了一种基于RandAugment的伪异常生成（RPAG）策略，可以通过随机创建局部不规则性来模拟异常，以提高不规则模式的数量和多样性。整个过程在附录中显示（图8），总结如下： 

### 构建增强集

借鉴自RandAugment [9]，我们首先选择K个可用的图像变换来构建一个增强集T := {T1, . . . , TK|Tk : I → I}：{翻转、旋转、转置、噪声、扭曲、亮度、锐度、平移、模糊}。 

### 随机增强

我们随机选择一个包含S个变换的增强子集TRS ⊂ T来增强异常样本：(Ia)' = TRS(Ia)，其中Ia ∈ Ia。 

### 选择粘贴位置

考虑到异常通常只出现在对象区域中，因此为了保证模拟异常的语义，我们应该将模拟异常的位置限制在对象区域内。我们采用前景掩码策略，在这种策略中，我们可以使用灰度二值化算法有效地定位前景对象MI = Binary(In)，其中In ∈ In。然后，我们可以从对象区域（MI = 1）中随机选择一个粘贴位置ra = Rand(MI = 1)，以避免在背景中生成异常区域。 

### 切割异常

我们切割增强后异常样本的异常区域：Ra = Cut((Ia)' )。 粘贴异常。我们将裁剪的异常区域粘贴回正常样本In的选定位置ra，以生成模拟异常样本：Isa = Paste(In, Ra, ra)。 

在DRAEM [52]和NSA [41]中，作者还尝试利用合成异常，我们通过比较我们的RPAG策略和它们的策略来进行验证，并在附录中显示结果。

# 实验

## 数据集与评价指标

### 数据集

在本工作中，我们专注于真实世界应用中的异常，例如工业缺陷检测和医学病变检测。具体而言，我们评估了六个真实世界的异常检测数据集，包括四个工业缺陷检测数据集：MVTecAD [4]、BTAD [25]、AITEX [43] 和ELPV [11]；以及用于检测不同器官上的病变的两个医学图像数据集：BrainMRI [38] 和HeadCT [38]。这些数据集的更详细介绍请见附录。

### 评价指标

在评估中，异常检测中的标准指标AUROC被使用[4,6,40]。**图像级AUROC**用于异常检测，**像素级AUROC**用于评估异常定位。为了平衡各种尺寸的真实异常区域，我们还采用了[5]中提出的Per-Region-Overlap（PRO）曲线指标。

## 实验设置

多类别设置旨在评估AD模型在检测已知异常类别方面的性能。在这种设置下，已知异常是从测试集中现有异常类别中随机抽取的少量异常样本。然后，在测试期间，我们会仔细排除这些添加的异常样本。

单类别设置旨在评估AD模型在检测未见异常类别方面的泛化能力。在这种设置下，已知异常仅从一个异常类别中随机抽样，并且将该类别的所有异常样本从测试集中移除，以确保测试集仅包含未见的异常类别。

由于异常通常是罕见的，我们的BGAD默认**使用每个类别十个随机异常样本进行训练**（我们还通过基于这些已知异常的RPAG生成了一些伪异常用于训练）。在移除已知异常后，我们设置的测试集与原始测试集不同。因此，为了公平比较，我们将所有比较的无监督和监督AD方法与我们的BGAD在相同的实验设置下重新运行，使用公开可用的实现。其他实现细节可以在附录中找到。

# 附录

## 实现细节

如图2所示，我们使用在ImageNet [54]数据集上预训练的Efficient-b6 [45]作为特征提取器，以提取三个级别的特征图，其中包括{4×，8×，16×}的下采样比率。特征提取器的参数在训练过程中被冻结，只有正规化流的参数是可学习的。提取的多尺度特征然后通过正规化流转换到潜在空间，正规化流由8个耦合层构成，类似于[15]。我们使用Adam优化器训练BGAD和BGADw/o，学习率为2e−4，训练轮数为200，批量大小为32，并采用余弦学习率退火策略，热身轮数为2。默认情况下，第3.3节中描述的归一化器设置为10，E.q.(9)中的超参数λ设置为1.0，默认的增强子集中的变换次数设置为3。默认情况下，超参数β设置为1，τ设置为0.1。在默认超参数的情况下，我们的BGAD在这六个数据集上可以有效地提高性能，超过NFAD。所有的训练和测试图像都被调整大小并从原始分辨率裁剪到256×256的分辨率。我们还使用平衡的批量采样器来确保每个小批量中正常样本和异常样本的比例为2:1，这可以在批处理级别上缓解稀有性问题。我们的主要代码基于作者在MIT许可下公开的[15]的CFLOW实现。预训练的特征提取器Efficient-b6来自Apache 2.0许可下的timm [54]库。我们模型中的正规化流主要基于Real-NVP [14]架构，但是Real-NVP中的卷积子网络被替换为线性子网络。我们的CNFlow还结合了来自最近作品[2,18,19]对正规化流的各种设计努力。与以往的作品一样，我们模型中的正规化流由所谓的耦合层组成。在我们的CNFlow中，每个耦合层设计为实现前向或反向仿射耦合计算，如图7所示。原生耦合层后面跟随着通道的随机和固定的软置换[2]，以及通过常数的固定缩放，类似于[19]引入的ActNorm层。对于耦合系数，每个子网络联合预测乘法和加法分量，就像[19]所做的那样。此外，我们采用了[14]中使用的乘法系数的软夹紧。

我们模型中正规化流的实现基于FrEIA库 [https://github.com/VLL-HD/FrEIA]，感谢作者的贡献，我们可以方便地实现非平凡的正规化流。我们模型的总参数为43M，但可学习参数仅为3.6M。我们的模型可以由一张GPU卡进行训练，模型的内存使用量仅约为2600MB，这意味着训练我们的模型通常不会出现内存不足的问题。在实验中，我们使用一张Titan-XPGPU卡在MVTecAD数据集上训练模型，总训练时间约为30小时，Titan-XP实现的推断速度约为每秒16帧。代码将公开在网上。

## 基于RandAugment的伪异常生成

RandAugment-based Pseudo Anomaly Generation (RPAG)的整个过程如图8所示。图9展示了RPAG生成的更多异常样本。

RPAG的优势在于，从生成的样本中学习识别不规则性可以很好地泛化到未见的异常。其局限性在于，**RPAG仍然不能完美地模拟真实的异常**。

基于RandAugment的伪异常生成的效果。为了展示基于RandAugment的伪异常生成的有效性，我们在表8中展示了使用或不使用RPAG的实验结果。可以发现，即使每个类别仅使用五个异常，我们的方法也能有效地提高检测性能。在五个异常的设置下，图像级AUROC、像素级AUROC和PRO的结果分别提高了0.3％、0.3％和1.0％。在十个异常的设置下，图像级AUROC、像素级AUROC和PRO的结果分别提高了0.5％、0.3％和0.7％。

与其他伪异常生成策略的比较。在DRAEM [52]和NSA [41]中，作者也尝试利用合成异常，我们将我们的RPAG策略与它们的策略进行比较，并在表9中展示结果。[52]中的策略是使用纹理样本模拟异常区域，并使用Perlin噪声捕捉各种异常形状。这种策略可能会生成无效的异常（即，异常出现在背景中），因为它会在整个图像中生成异常区域，而我们的策略可以通过区域限制来确保生成更有效的异常。[[NSA]] [41]将泊松图像编辑与缩放其他正常图像中各种大小的正常补丁无缝融合。相比之下，我们策略模拟的异常比[41]中的更真实，因为它基于一些真实的异常。与这些异常生成策略相比，RPAG更适合我们的方法，因为它可以更充分地利用少量已知异常。