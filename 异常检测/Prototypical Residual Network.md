---
Publish: CVPR
创新点: 
文档链接: https://arxiv.org/pdf/2212.02031.pdf
Year: "2023"
I-AUROC-MVTecAD: "99.4"
P-AUROC-MVTecAD: "99.0"
合成异常的方式: 是
标题: Prototypical Residual Networks for Anomaly Detection and Localization
监督方式: 有监督
---
- 训练批量大小为 64，包括 32 个正常样本、16 个扩展异常和 16 个模拟异常，输出是分割热图。

# 摘要

【现有工作及不足】异常检测和定位在工业制造中被广泛应用，因为其效率和有效性。异常很少见，难以收集，而监督模型很容易过拟合这些已见异常，仅使用少量异常样本就会产生不理想的性能。另一方面，异常通常是微妙的，难以辨别，并且外观各异，这使得检测异常，更不用说定位异常区域变得困难。

为了解决这些问题，我们提出了一个名为原型残差网络（PRN）的框架，它学习异常和正常模式之间不同尺度和大小的特征残差，以准确重建异常区域的分割图。PRN主要由两部分组成：多尺度原型，明确表示异常与正常模式的残差特征；多尺寸自注意机制，使得变尺寸异常特征学习成为可能。此外，我们提出了多种异常生成策略，考虑了已见和未见外观变化，以扩大和丰富异常。对具有挑战性且广泛使用的MVTec AD基准的广泛实验表明，PRN优于当前最先进的无监督和监督方法。我们进一步报告了在另外三个数据集上的SOTA结果，以证明PRN的有效性和泛化能力。

# 引言

人类认知和视觉系统具有感知异常的固有能力。人类不仅能区分有缺陷和无缺陷的图像，而且即使他们没有看到或只看到有限数量的异常，他们也能指出异常的位置。异常检测（图像级别的二元分类）和异常定位（像素级别的二元分类）被引入了相同的目的，并且由于其效率和显著的准确性，在各种情况下被广泛使用，包括工业缺陷检测、医学图像分析和视频监控。鉴于其重要性，已经有大量工作致力于异常检测和异常定位，但很少有人同时很好地解决了检测和定位问题。我们认为现实世界的异常数据主要在三个方面削弱了这些模型：
- I）异常样本数量有限，显著少于正常样本，导致数据分布呈现自然的不平衡学习问题；
- II）异常通常微妙难辨，因为正常模式仍然占据着异常图像的主导地位；识别整个图像中的异常区域是异常检测和定位的关键；
- III）异常的外观变化显著，即异常区域可以呈现出各种大小、形状和数量，这种外观变化使得很难很好地定位所有异常。

缺乏足够的异常用于训练，**无监督模型成为事实上的主导方法**，通过学习正常样本的分布或生成足够的合成异常来摆脱不平衡问题。然而，这些方法对真实异常是不透明的，导致可能产生许多误报和漏报。此外，无监督方法严重依赖于正常样本的质量，因此在未校准或嘈杂的数据集上表现不够稳健且性能较差。正如图1所示，无监督模型预测异常周围的广泛区域。我们将这个问题归因于这些方法的较低的区分能力。最近，出现了几种监督方法。[[DeepSAD]]扩大了潜在空间中异常和单类中心之间的边界，以通过限制见过的异常来获得更紧凑的单类描述符。[[DRA]]和[[DevNet]]将异常检测制定为**多示例学习**问题，如果任何图像块是缺陷区域，则将图像评分为异常。基于多示例学习的方法强化了对细粒度图像块级别的学习，从而有效减少了异常图像中正常块的干扰。然而，这些方法通常在具有图像级别监督的情况下难以准确地定位所有异常区域，如图1所示。特别是，当异常区域只占据图像块的一小部分时，图像级别的表示可能会被正常区域所主导，而忽略了微小的异常，这可能导致图像级别和像素级别性能的不一致，如表1所示。此外，如图2所示，这些方法在做出决策时也会遇到不可解释的问题。

【提出本文方法】在本文中，我们提出了一个名为原型残差网络（PRN）的框架，作为解决异常检测和定位问题的有效方法。首先，我们提出了多尺度原型来表示正常模式。与以前的方法不同，以前的方法是从连接的特征内存或随机抽样的特征图构建正常模式，我们使用不同尺度的中间特征图的原型构建正常模式，从而保留了空间信息并提供了精确和代表性的正常模式。此外，我们通过在每个尺度上的异常图像与最接近的原型之间的偏差来获得特征图残差，并添加多尺度融合块以在不同尺度之间交换信息。其次，由于异常区域的外观变化很大，因此有必要学习来自多个感受野的补丁之间的关系。因此，我们引入了一个多尺寸自注意机制，它在不同尺寸的感受野的补丁上操作，以检测不同尺寸的补丁级别的不一致性。最后，与以前使用图像级别监督进行训练的方法不同，我们的模型学习使用像素级别监督重建异常分割图，这更专注于异常区域并且保留了更好的泛化性能。此外，我们提出了多种异常生成策略，有效地减轻了数据不平衡的影响并丰富了异常外观。通过提出的模块，我们的方法实现了比以前的无监督和监督方法更准确的定位，如图1和图2所示。

【总结本文贡献】本文的主要贡献总结如下：我们提出了一种新颖的原型残差网络，用于异常检测和定位。PRN装备了多尺度原型和多尺寸自注意机制，学习了多尺度特征图之间的残差表示以及在每个尺度上的多尺寸感受野之间的关系。我们提出了多种异常生成策略，考虑到了已见和未见外观变化，以扩大和丰富异常。我们在四个数据集上进行了大量实验，表明我们的方法在异常检测性能方面实现了新的SOTA，并且在异常定位性能方面表现出了明显的优势。

# 相关工作

## 无监督方法

## 有监督方法

最近出现的一个新兴趋势是通过利用已见异常来增加异常和正常样本之间的区分度，从而进行监督异常检测。一些现有工作[16, 31, 46]是基于 one-class classification 指标学习的，它们利用少量异常来学习。一些在[35, 69]中提出的以异常为重点的偏差损失减轻了由已见异常引起的偏差。在[13]中引入了一个多头模型来学习解耦的异常表示，其中每个头部专门用于捕获特定类型的异常。由于不平衡学习问题，这些方法**很容易过度拟合到已见异常**，并且无法推广到未见异常，导致异常检测性能较差。此外，图像级别的表示可能会被正常区域所主导，而忽略了微妙异常区域的表示，导致无法准确定位各种大小、形状和数量的异常。

# 方法

除了提出的保持平衡数据分布的异常生成策略（附录A.1）之外，我们提出了原型残差网络（PRN）来重建异常检测和定位的分割图。总体上，我们采用类似于U-Net [40]的架构，如图3所示。**编码器**是一个预训练的ResNet-18 [21]，**解码器**由上采样和卷积块组成。PRN的跳跃连接分支配备了提出的多尺度原型（MP，第3.1节）、多尺度融合块（MF，第3.2节）和多尺寸自注意机制（MSA，第3.3节）。接下来，我们将具体描述每个部分。

## Multi-scale Prototypes

### Prototype Initialization

## Anomaly Generation Strategies

为了缓解数据不平衡问题，我们提出了两种在线异常生成策略，可以生成各种类型的异常。一种策略是通过将增强的异常区域从已见异常放置在正常样本上来创建分布内异常，这些生成的异常被称为扩展异常（EA）。EA扩大了异常的数量并缓解了数据不平衡问题。另一种策略是使用没有已见异常知识的正常样本来创建分布外异常[68]。这些生成的异常被称为模拟异常（SA），补充了潜在的未见异常。

### Simulated Anomalies

类似于DRAEM [68]，我们将Perlin [37]噪声与DTD [8]数据集中的随机纹理相乘，并将这些增强的纹理应用于正常图像。由于这些异常与已见异常显著不同，我们将这些分布外异常称为异类异常（HEA）。为了进一步扩大模拟异常的多样性，我们引入了同类异常（HOA），其中通过Perlin噪声相乘的异常被增强到正常图像上。请注意，上述提到的TA也适用于模拟异常的生成。有关HEA和HOA的更多详细信息，请参阅补充材料。

## Training and Inference
  
PRN 的解码器输出 anomaly score map $\mathcal{M}_{o}$，其形状与 ground truth mask $\mathcal{M}$ 相同。受[68]和[63]的启发，分别应用了焦点损失[29]和平滑L1损失[14]，以增强对困难样本的准确分割的鲁棒性，并减少对异常值的过度敏感性。

# 实验

## 实验细节

### 数据集

为验证我们方法的有效性和泛化能力，我们在多个数据集上进行实验，即MVTec异常检测（MVTec AD [4]）、DAGM [61]、BeanTech异常检测数据集（BTAD [34]）和KolektorSDD2 [7]。MVTec AD包含10个对象子数据集和5个纹理子数据集。每个子数据集呈现了一个多样化的异常集合，可以对表面异常检测方法进行一般性评估。DAGM包含10个带有小异常区域的纹理对象，这些异常区域在视觉上与背景非常相似。BTAD包括三类展示不同体和表面缺陷的真实工业产品。KolektorSDD2是一个表面缺陷数据集，缺陷的形状、大小和颜色各异，从小的划痕和斑点到大的表面缺陷。**我们采用了通用的监督设置，其中每个子数据集的训练集仅包含10个异常样本。**更多详细信息将在补充材料中提供。

### 评估指标

我们按照先前的工作，通过图像级别（Image-AUROC）和像素级别（Pixel-AUROC）的接收器操作特征曲线下面积来评估结果。然而，异常区域通常仅占整个图像的一小部分。因此，由于假阳性率主要由非异常像素的极高数量主导，并且尽管存在假阳性检测，但 Pixel-AUROC 不能准确反映定位精度 [53]。为了全面衡量定位性能，我们引入了区域重叠（PRO）[5]分数和像素级平均精度（AP）[68]。PRO 分数平等地处理不同大小的异常区域 [12, 41]，而 AP 对于高度不平衡的类别更为合适，尤其是对于工业异常定位，其中准确性至关重要 [68]。

### 实现细节

四个数据集中的所有图像都被调整大小为 256 × 256。我们使用在ImageNet上预训练的 ResNet-18 [21] 的第 1 层、第 2 层和第 3 层来获取特征映射，分别具有 64 × 64 × 64、128 × 32 × 32 和 256 × 16 × 16 的尺度，并在训练期间冻结这些块。原型的数量取决于数据集，并占总正常样本数量的 10%。每个尺度的 k-means 的最大迭代次数设置为 300 次。我们使用 Adam 优化器 [24] 进行参数优化，初始学习率为 $10^{-4}$，权重衰减为 $10^{-2}$。焦点损失中的 α 和 γ 分别设置为 0.5 和 4。总损失中的 λ 设置为 5。我们训练了 700 个周期，**批量大小为 64，包括 32 个正常样本、16 个扩展异常和 16 个模拟异常**，以确保异常的多样性。我们将前 100 个异常像素的平均值作为图像级异常分数。我们将 PRN 与七种无监督的 SOTA 方法和两种监督的 SOTA 方法进行比较。我们报告的结果基于这些方法提供的实现。PatchCore [41]、RD4AD [12]、CFLOW [18] 和 CFA [25] 的骨干网络是 WideResNet50。SSPCAB [1,39] 替换了 DRAEM [68] 中重构编码器的倒数第二个卷积层。DevNet [35] 提出网络给出的异常分数可以进一步反向传播到原始图像像素，以推断哪些像素是异常的主要贡献者，用于异常定位。我们使用这种方法来获得 DRA [13] 的异常定位性能。

## Anomaly Detection and Localization on MVTec

| PRN       | DRA       | DevNet    | PatchCore |
| --------- | --------- | --------- | --------- |
| 监督        | 监督        | 监督        | 无监督       |
| 96.1/78.6 | 73.3/26.0 | 71.4/24.4 | 93.9/56.3 |
# 附录

## Anomaly Generation Strategies

本节详细介绍了模拟异常的生成过程。首先，通过Perlin噪声生成器[37, 68]生成噪声图像，然后保留目标区域内的噪声部分作为ground truth mask。